<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学函数绘图工具(Canvas版)</title>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet"> -->
    <link rel="stylesheet" href="./font-awesome.min.css">
    <style>
        /* 样式部分保持不变，与之前相同 */
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #ea4335;
            --dark-color: #202124;
            --light-color: #f8f9fa;
            --border-color: #dadce0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --card-bg: #ffffff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow-color);
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="10" height="10" fill="white" fill-opacity="0.1"/></svg>');
            opacity: 0.1;
            pointer-events: none;
        }
        
        .header h1 {
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-weight: 400;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .main-container {
            display: flex;
            flex-wrap: wrap;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            gap: 1.5rem;
        }
        
        .graph-container {
            flex: 2;
            min-width: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px var(--shadow-color);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .graph-container:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .control-panel {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px var(--shadow-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        #graph-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        .control-group h3 {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        select, input[type="text"], input[type="color"] {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
        }
        
        select:hover, input[type="text"]:hover, input[type="color"]:hover {
            border-color: var(--primary-color);
        }
        
        select:focus, input[type="text"]:focus, input[type="color"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }
        
        .btn-group {
            display: flex;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        
        button {
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex: 1;
        }
        
        button i {
            font-size: 1.1rem;
        }
        
        button.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        button.primary:hover {
            background-color: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        button.secondary {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--border-color);
        }
        
        button.secondary:hover {
            background-color: #e8eaed;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        
        .range-container label {
            min-width: 80px;
            margin-bottom: 0;
        }
        
        input[type="range"] {
            flex-grow: 1;
            height: 8px;
            -webkit-appearance: none;
            background: var(--border-color);
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: var(--secondary-color);
        }
        
        .range-value {
            font-weight: 500;
            min-width: 40px;
            text-align: center;
            background: var(--light-color);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .function-display {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
            border: 1px solid var(--border-color);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 0.5rem;
            width: 1.1rem;
            height: 1.1rem;
        }
        
        .graph-hint {
            text-align: center;
            margin-top: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 30px;
            height: 30px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: var(--dark-color);
        }
        
        .zoom-btn:hover {
            background: var(--light-color);
        }
        
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
            }
            
            .graph-container, .control-panel {
                min-width: 100%;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .control-group:nth-child(1) { animation-delay: 0.1s; }
        .control-group:nth-child(2) { animation-delay: 0.2s; }
        .control-group:nth-child(3) { animation-delay: 0.3s; }
        .control-group:nth-child(4) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> 数学函数绘图工具</h1>
        <p>交互式函数图像可视化教学工具 - 探索各种数学函数的图形</p>
    </div>
    
    <div class="main-container">
        <div class="control-panel">
            <div class="control-group">
                <h3><i class="fas fa-function"></i> 函数选择</h3>
                <div class="form-group">
                    <select id="function-select">
                        <option value="">-- 选择函数 --</option>
                        <option value="x">一次函数: y = x</option>
                        <option value="2*x+1">一次函数: y = 2*x + 1</option>
                        <option value="x^2">二次函数: y = x²</option>
                        <option value="x^2-2*x+1">二次函数: y = x² - 2*x + 1</option>
                        <option value="2^x">指数函数: y = 2^x</option>
                        <option value="(1/2)^x">指数函数: y = (1/2)^x</option>
                        <option value="Math.sqrt(x)">幂函数: y = √x</option>
                        <option value="x^3">幂函数: y = x³</option>
                        <option value="sin(x)">三角函数: y = sin(x)</option>
                        <option value="cos(x)">三角函数: y = cos(x)</option>
                        <option value="tan(x)">三角函数: y = tan(x)</option>
                        <option value="log(x)">对数函数: y = ln(x)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="custom-function">自定义函数 (使用x作为变量)</label>
                    <input type="text" id="custom-function" placeholder="例如: 2*sin(x)+1">
                </div>
                
                <div class="btn-group">
                    <button id="plot-btn" class="primary">
                        <i class="fas fa-project-diagram"></i> 绘制函数
                    </button>
                    <button id="reset-btn" class="secondary">
                        <i class="fas fa-trash-alt"></i> 重置
                    </button>
                </div>
            </div>
            
            <div class="control-group">
                <h3><i class="fas fa-palette"></i> 图像设置</h3>
                <div class="form-group" style="display: none;">
                    <label for="line-color">函数颜色</label>
                    <input type="color" id="line-color" value="#ff0000">
                </div>
                
                <div class="form-group">
                    <label>网格设置</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-grid" checked>
                        <label for="show-grid">显示网格</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-axes" checked>
                        <label for="show-axes">显示坐标轴</label>
                    </div>
                    
                    <div class="range-container" style="margin-top: 0.5rem;">
                        <label for="grid-size">网格大小:</label>
                        <input type="range" id="grid-size" min="0.1" max="2" step="0.1" value="0.5">
                        <span id="grid-size-value" class="range-value">0.5</span>
                    </div>
                </div>
            </div>
            
            <!-- <div class="control-group">
                <h3><i class="fas fa-info-circle"></i> 当前函数</h3>
                <div class="function-display">
                    <strong>当前函数:</strong> <span id="current-function">未选择函数</span>
                </div>
            </div> -->
        </div>
        
        <div class="graph-container">
            <canvas id="graph-canvas"></canvas>
            <div class="zoom-controls">
                
                <button class="zoom-btn" id="zoom-out"><i class="fas fa-plus"></i></button>
                <button class="zoom-btn" id="zoom-in"><i class="fas fa-minus"></i></button>
                <button class="zoom-btn" id="zoom-reset"><i class="fas fa-sync-alt"></i></button>
            </div>
            <!-- <div class="graph-hint">
                提示: 拖动鼠标可以平移视图，滚轮可以缩放
            </div> -->
        </div>
    </div>

    <script>
        // 获取DOM元素
        const functionSelect = document.getElementById('function-select');
        const customFunction = document.getElementById('custom-function');
        const plotBtn = document.getElementById('plot-btn');
        const resetBtn = document.getElementById('reset-btn');
        const lineColor = document.getElementById('line-color');
        const showGrid = document.getElementById('show-grid');
        const showAxes = document.getElementById('show-axes');
        const gridSize = document.getElementById('grid-size');
        const gridSizeValue = document.getElementById('grid-size-value');
        // const currentFunctionDisplay = document.getElementById('current-function');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomResetBtn = document.getElementById('zoom-reset');
        
        // 获取Canvas元素和上下文
        const canvas = document.getElementById('graph-canvas');
        const ctx = canvas.getContext('2d');
        
        // 设置Canvas尺寸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawGraph();
        }
        
        // 初始化变量
        let currentFunction = null;
        let isDragging = false;
        let lastX = 0;
        let lastY = 0;
        let translateX = 0;
        let translateY = 0;
        let scale = 1;
        
        // 视图范围
        let view = {
            xMin: -5,
            xMax: 5,
            yMin: -5,
            yMax: 5
        };
        
        // 初始化
        window.addEventListener('load', () => {
            resizeCanvas();
            updateRangeValues();
            window.addEventListener('resize', resizeCanvas);
            
            // 添加事件监听
            canvas.addEventListener('mousedown', startDrag);
            canvas.addEventListener('mousemove', drag);
            canvas.addEventListener('mouseup', endDrag);
            canvas.addEventListener('mouseleave', endDrag);
            canvas.addEventListener('wheel', handleZoom);
            
            zoomInBtn.addEventListener('click', () => zoom(1.2));
            zoomOutBtn.addEventListener('click', () => zoom(0.8));
            zoomResetBtn.addEventListener('click', resetView);
        });
        
        // 更新范围值显示
        function updateRangeValues() {
            gridSizeValue.textContent = gridSize.value;
            drawGraph();
        }
        
        // 绘制坐标轴和网格
        function drawAxesAndGrid() {
            const width = canvas.width;
            const height = canvas.height;
            
            // 清除画布
            ctx.clearRect(0, 0, width, height);
            
            // 计算坐标转换
            const xToPixel = (x) => (x - view.xMin) / (view.xMax - view.xMin) * width;
            const yToPixel = (y) => height - (y - view.yMin) / (view.yMax - view.yMin) * height;
            
            // 绘制网格
            if (showGrid.checked) {
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                
                const gridStep = parseFloat(gridSize.value);
                
                // 垂直网格线
                for (let x = Math.ceil(view.xMin / gridStep) * gridStep; x <= view.xMax; x += gridStep) {
                    if (Math.abs(x) < 0.001) continue; // 跳过0点，避免与坐标轴重叠
                    
                    ctx.beginPath();
                    ctx.moveTo(xToPixel(x), 0);
                    ctx.lineTo(xToPixel(x), height);
                    ctx.stroke();
                }
                
                // 水平网格线
                for (let y = Math.ceil(view.yMin / gridStep) * gridStep; y <= view.yMax; y += gridStep) {
                    if (Math.abs(y) < 0.001) continue; // 跳过0点，避免与坐标轴重叠
                    
                    ctx.beginPath();
                    ctx.moveTo(0, yToPixel(y));
                    ctx.lineTo(width, yToPixel(y));
                    ctx.stroke();
                }
            }
            
            // 绘制坐标轴
            if (showAxes.checked) {
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                
                // X轴
                if (view.yMin <= 0 && view.yMax >= 0) {
                    ctx.beginPath();
                    ctx.moveTo(0, yToPixel(0));
                    ctx.lineTo(width, yToPixel(0));
                    ctx.stroke();
                    
                    // X轴刻度
                    const xStep = (view.xMax - view.xMin) / 10;
                    for (let x = Math.ceil(view.xMin / xStep) * xStep; x <= view.xMax; x += xStep) {
                        ctx.beginPath();
                        ctx.moveTo(xToPixel(x), yToPixel(0) - 5);
                        ctx.lineTo(xToPixel(x), yToPixel(0) + 5);
                        ctx.stroke();
                        
                        // 刻度标签 - 使用更清晰的字体样式
                        if (Math.abs(x) > 0.001) { // 避免在原点显示0
                            ctx.font = '12px "Noto Sans SC", sans-serif';
                            ctx.fillStyle = '#000000';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'top';
                            ctx.fillText(x.toFixed(1), xToPixel(x), yToPixel(0) + 8);
                        }
                    }
                }
                
                // Y轴
                if (view.xMin <= 0 && view.xMax >= 0) {
                    ctx.beginPath();
                    ctx.moveTo(xToPixel(0), 0);
                    ctx.lineTo(xToPixel(0), height);
                    ctx.stroke();
                    
                    // Y轴刻度
                    const yStep = (view.yMax - view.yMin) / 10;
                    for (let y = Math.ceil(view.yMin / yStep) * yStep; y <= view.yMax; y += yStep) {
                        ctx.beginPath();
                        ctx.moveTo(xToPixel(0) - 5, yToPixel(y));
                        ctx.lineTo(xToPixel(0) + 5, yToPixel(y));
                        ctx.stroke();
                        
                        // 刻度标签 - 使用更清晰的字体样式
                        if (Math.abs(y) > 0.001) { // 避免在原点显示0
                            ctx.font = '12px "Noto Sans SC", sans-serif';
                            ctx.fillStyle = '#000000';
                            ctx.textAlign = 'right';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(y.toFixed(1), xToPixel(0) - 8, yToPixel(y));
                        }
                    }
                }
                
                // 原点标签
                if (view.xMin <= 0 && view.xMax >= 0 && view.yMin <= 0 && view.yMax >= 0) {
                    ctx.font = '12px "Noto Sans SC", sans-serif';
                    ctx.fillStyle = '#000000';
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'top';
                    ctx.fillText('0', xToPixel(0) - 8, yToPixel(0) + 8);
                }
            }
        }
        
        // 绘制函数图像
        function drawFunction() {
            if (!currentFunction) return;
            
            const width = canvas.width;
            const height = canvas.height;
            
            // 计算坐标转换
            const xToPixel = (x) => (x - view.xMin) / (view.xMax - view.xMin) * width;
            const yToPixel = (y) => height - (y - view.yMin) / (view.yMax - view.yMin) * height;
            
            // 设置绘图样式
            ctx.strokeStyle = lineColor.value;
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            // 计算步长
            const step = (view.xMax - view.xMin) / width;
            
            // 绘制函数
            let firstPoint = true;
            for (let x = view.xMin; x <= view.xMax; x += step) {
                try {
                    // 计算y值
                    const y = evaluateFunction(currentFunction, x);
                    
                    // 跳过无效值
                    if (isNaN(y) || !isFinite(y)) {
                        firstPoint = true;
                        continue;
                    }
                    
                    // 如果y值超出视图范围，跳过
                    if (y < view.yMin || y > view.yMax) {
                        firstPoint = true;
                        continue;
                    }
                    
                    // 移动到第一个点或连线到下一个点
                    if (firstPoint) {
                        ctx.moveTo(xToPixel(x), yToPixel(y));
                        firstPoint = false;
                    } else {
                        ctx.lineTo(xToPixel(x), yToPixel(y));
                    }
                } catch (e) {
                    firstPoint = true;
                }
            }
            
            ctx.stroke();
        }
        // 自动为数学函数添加Math.前缀
        function normalizeFunctionExpression(expr) {
            // 替换^为**以支持幂运算
            expr = expr.replace(/\^/g, '**');
            
            // 为数学函数添加Math.前缀
            const mathFunctions = ['sin', 'cos', 'tan', 'log', 'sqrt', 'abs', 'exp', 'pow'];
            
            mathFunctions.forEach(func => {
                const regex = new RegExp(`(^|[^\\w.])${func}\\(`, 'g');
                expr = expr.replace(regex, `$1Math.${func}(`);
            });
            
            return expr;
        }
        // 评估函数表达式
        function evaluateFunction(funcStr, x) {
            // 替换^为**以支持幂运算
            // const expr = funcStr.replace(/\^/g, '**');
            // 规范化函数表达式
            const expr = normalizeFunctionExpression(funcStr);
            
            // 使用Function构造函数创建函数
            try {
                const func = new Function('x', `return ${expr};`);
                return func(x);
            } catch (e) {
                console.error('函数评估错误:', e);
                return NaN;
            }
        }
        
        // 绘制整个图形
        function drawGraph() {
            drawAxesAndGrid();
            drawFunction();
        }
        
        // 绘制函数图像
        function plotFunction() {
            let func = '';
            
            if (functionSelect.value) {
                func = functionSelect.value;
                customFunction.value = func;
            } else if (customFunction.value.trim()) {
                func = customFunction.value.trim();
            }
            
            if (func) {
                try {
                    // 测试函数是否有效
                    evaluateFunction(func, 0);
                    
                    currentFunction = func;
                    // currentFunctionDisplay.textContent = `y = ${func.replace(/\*\*/g, '^')}`;
                    drawGraph();
                } catch (e) {
                    alert('无效的函数表达式: ' + e.message);
                }
            }
        }
        
        // 重置图形
        function resetGraph() {
            // 重置视图
            view = {
                xMin: -5,
                xMax: 5,
                yMin: -5,
                yMax: 5
            };
            
            // 重置输入
            functionSelect.value = '';
            customFunction.value = '';
            currentFunction = null;
            // currentFunctionDisplay.textContent = '未选择函数';
            
            // 重置滑块
            gridSize.value = 1;
            showGrid.checked = true;
            showAxes.checked = true;
            
            updateRangeValues();
            drawGraph();
        }
        
        // 重置视图
        function resetView() {
            view = {
                xMin: -5,
                xMax: 5,
                yMin: -5,
                yMax: 5
            };
            
            drawGraph();
        }
        
        // 缩放视图
        function zoom(factor) {
            const centerX = (view.xMin + view.xMax) / 2;
            const centerY = (view.yMin + view.yMax) / 2;
            
            const width = (view.xMax - view.xMin) * factor;
            const height = (view.yMax - view.yMin) * factor;
            
            view.xMin = centerX - width / 2;
            view.xMax = centerX + width / 2;
            view.yMin = centerY - height / 2;
            view.yMax = centerY + height / 2;
            
            drawGraph();
        }
        
        // 鼠标滚轮缩放
        function handleZoom(e) {
            e.preventDefault();
            
            const mouseX = e.clientX - canvas.getBoundingClientRect().left;
            const mouseY = e.clientY - canvas.getBoundingClientRect().top;
            
            const graphX = view.xMin + (view.xMax - view.xMin) * mouseX / canvas.width;
            const graphY = view.yMax - (view.yMax - view.yMin) * mouseY / canvas.height;
            
            const factor = e.deltaY < 0 ? 0.8 : 1.2;
            
            view.xMin = graphX - (graphX - view.xMin) * factor;
            view.xMax = graphX + (view.xMax - graphX) * factor;
            view.yMin = graphY - (graphY - view.yMin) * factor;
            view.yMax = graphY + (view.yMax - graphY) * factor;
            
            drawGraph();
        }
        
        // 开始拖动
        function startDrag(e) {
            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
        }
        
        // 拖动中
        function drag(e) {
            if (!isDragging) return;
            
            const dx = e.clientX - lastX;
            const dy = e.clientY - lastY;
            
            const xRange = view.xMax - view.xMin;
            const yRange = view.yMax - view.yMin;
            
            view.xMin -= dx / canvas.width * xRange;
            view.xMax -= dx / canvas.width * xRange;
            view.yMin += dy / canvas.height * yRange;
            view.yMax += dy / canvas.height * yRange;
            
            lastX = e.clientX;
            lastY = e.clientY;
            
            drawGraph();
        }
        
        // 结束拖动
        function endDrag() {
            isDragging = false;
        }
        
        // 事件监听
        plotBtn.addEventListener('click', plotFunction);
        resetBtn.addEventListener('click', resetGraph);
        functionSelect.addEventListener('change', plotFunction);
        customFunction.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') plotFunction();
        });
        
        gridSize.addEventListener('input', updateRangeValues);
        
        [showGrid, showAxes].forEach(el => {
            el.addEventListener('change', drawGraph);
        });
        
        lineColor.addEventListener('input', () => {
            if (currentFunction) drawGraph();
        });
    </script>
</body>
</html>