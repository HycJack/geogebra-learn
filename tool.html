<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8" />
    <title>Geogebra 工具</title>
    
    <script src="https://cdn.geogebra.org/apps/deployggb.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./renderer.css">
    <style>
        .ggb-container {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        #ggbApplet {
            width: 100%;
            height: 100%;
        }
        
        /* Annotation Tool Styles */
        #annotation-toolbar {
            position: fixed;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        
        #annotation-toolbar.expanded {
            opacity: 1;
            pointer-events: auto;
        }
        
        #annotation-toolbar button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #555;
            background: none;
            border: none;
            padding: 0;
        }
        
        #annotation-toolbar button:hover {
            background: #f0f0f0;
            color: #000;
        }
        
        #annotation-toolbar button.active {
            background: var(--primary-color);
            color: white;
        }
        
        #annotation-toolbar button.cursor-mode {
            background: var(--secondary-color) !important;
            color: white !important;
        }
        
        #annotation-toolbar i {
            font-size: 18px;
            pointer-events: none;
        }
        
        #annotation-toolbar select, 
        #annotation-toolbar input[type="range"] {
            width: 100%;
            padding: 5px;
            border-radius: 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
        }
        
        #annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        .annotation-active #annotation-canvas {
            pointer-events: auto;
        }
        
        #annotation-textInput {
            position: absolute;
            border: 1px dashed #000;
            padding: 8px 12px;
            display: none;
            background: rgba(255, 255, 255, 0.95);
            z-index: 50;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 100px;
            font-family: inherit;
            font-size: 16px;
            outline: none;
        }
        
        .color-preview {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
            border: 1px solid #ddd;
        }
        
        .tool-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            align-items: center;
            width: 100%;
        }
        
        .tool-group:last-child {
            border-bottom: none;
        }
        
        #toggle-annotation {
            position: fixed;
            bottom: 100px;
            right: 30px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .annotation-active #toggle-annotation {
            background-color: #f44336;
        }
        
        .hidden {
            display: none !important;
        }
        
        .drawing-mode #annotation-toolbar {
            opacity: 0;
            pointer-events: none;
        }
        
        .cursor-mode #annotation-canvas {
            pointer-events: none !important;
        }
        
    </style>
</head>

<body>
    <header class="header">
        <h1>Geogebra 工具</h1>
        
    </header>

    <div class="main-content-area">
        <div class="ggb-container">
            <div id="ggbApplet"></div>
        </div>
    </div>
    <!-- Annotation Tool Toggle -->
    <button id="toggle-annotation" title="标注工具">
        <i class="fas fa-pen"></i>
    </button>
<!-- Annotation Toolbar -->
    <div id="annotation-toolbar">
        <div class="tool-group">
            <button id="anno-cursorBtn" title="选择模式"><i class="fas fa-mouse-pointer"></i></button>
            <button id="anno-arrowBtn" title="箭头"><i class="fas fa-arrow-right"></i></button>
            <button id="anno-rectBtn" title="矩形"><i class="fas fa-square"></i></button>
            <button id="anno-circleBtn" title="圆形"><i class="fas fa-circle"></i></button>
        </div>
        <div class="tool-group">
            <!-- <button id="anno-textBtn" title="文字"><i class="fas fa-font"></i></button> -->
            <button id="anno-penBtn" title="画笔"><i class="fas fa-pen"></i></button>
        </div>
        <div class="tool-group">
            <button id="anno-undoBtn" title="撤销"><i class="fas fa-undo"></i></button>
            <button id="anno-redoBtn" title="重做"><i class="fas fa-redo"></i></button>
            <button id="anno-clearBtn" title="清除所有"><i class="fas fa-trash-alt"></i></button>
        </div>
        <div class="tool-group">
            <select id="anno-colorSelect">
                <option value="#ff0000" selected><span class="color-preview" style="background:#ff0000"></span> 红色</option>
                <option value="#0000ff"><span class="color-preview" style="background:#0000ff"></span> 蓝色</option>
                <option value="#00ff00"><span class="color-preview" style="background:#00ff00"></span> 绿色</option>
                <option value="#ffff00"><span class="color-preview" style="background:#ffff00"></span> 黄色</option>
                <option value="#ff00ff"><span class="color-preview" style="background:#ff00ff"></span> 紫色</option>
                <option value="#000000"><span class="color-preview" style="background:#000000"></span> 黑色</option>
            </select>
            <input type="range" id="anno-sizeSlider" min="1" max="30" value="3" title="线条粗细" style="display: none;">
        </div>
    </div>
    
    <canvas id="annotation-canvas" class="hidden"></canvas>
    <div id="annotation-textInput" contenteditable="true"></div>
    <script>
// "customToolBar": "0 | 1 501 5 19 , 67 | 2 15 45 18 , 7 37 | 514 3 9 , 13 44 , 47 | 16 | 551 550 11 ,  20 22 21 23 , 55 56 57 , 12 | 69 | 510 511 , 512 513 | 533 531 , 534 532 , 522 523 , 537 536 , 535 | 521 520 | 36 , 38 49 560 | 571 30 29 570 31 33 | 17 | 540 40 41 42 , 27 28 35 , 6 , 502",
            
        const parameters = {
            "id": "ggbApplet",
            "showMenuBar": true,
            "showAlgebraInput": true,
            "showToolBar": true,
            "showToolBarHelp": true,
            "showResetIcon": true,
            "enableLabelDrags": true,
            "enableShiftDragZoom": true,
            "enableRightClick": true,
            "errorDialogsActive": false,
            "useBrowserForJS": false,
            "allowStyleBar": false,
            "preventFocus": false,
            "showZoomButtons": true,
            "capturingThreshold": 3,
            "showFullscreenButton": true,
            "scale": 1,
            "disableAutoScale": false,
            "allowUpscale": false,
            "clickToLoad": false,
            "appName": "classic",
            "buttonRounding": 0.7,
            "buttonShadows": false,
            "language": "zh-CN",
            
            "appletOnLoad": function(api) {
                ggbApp = api;
            }
        };
        // "filename": "./file_loading_demo/myfile.ggb",
        // Initialize GeoGebra Applet
        function initGeoGebra() {
            const applet = new GGBApplet(parameters, true);
            applet.inject('ggbApplet');
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initGeoGebra();
            initAnnotationTool();
        });
        // --- Annotation Tool Code ---
    function initAnnotationTool() {
            const container = document.querySelector('.ggb-container');
            const canvas = document.createElement('canvas');
            canvas.id = 'annotation-canvas';
            canvas.className = 'hidden';
            container.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            const textInput = document.getElementById('annotation-textInput');
            const toolbar = document.getElementById('annotation-toolbar');
            const toggleBtn = document.getElementById('toggle-annotation');
            
            let isAnnotationActive = false;
            let isDrawing = false;
            let currentTool = 'arrow';
            let startX, startY;
            let color = document.getElementById('anno-colorSelect').value;
            let size = parseInt(document.getElementById('anno-sizeSlider').value);
            let drawings = [];
            let undoneDrawings = [];
            let currentDrawing = null;
            
            function resizeCanvas() {
                const containerRect = container.getBoundingClientRect();
                canvas.width = containerRect.width;
                canvas.height = containerRect.height;
                redrawAll();
            }
            
            function redrawAll() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawings.forEach(draw => {
                    drawShape(draw);
                });
            }
            
            window.addEventListener('resize', () => {
                resizeCanvas();
            });
            
            resizeCanvas();
            
            toggleBtn.addEventListener('click', () => {
                isAnnotationActive = !isAnnotationActive;
                
                if (isAnnotationActive) {
                    document.body.classList.add('annotation-active');
                    toolbar.classList.add('expanded');
                    canvas.classList.remove('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                    toggleBtn.title = "关闭标注工具";
                } else {
                    document.body.classList.remove('annotation-active');
                    document.body.classList.remove('drawing-mode');
                    toolbar.classList.remove('expanded');
                    canvas.classList.add('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-pen"></i>';
                    toggleBtn.title = "标注工具";
                }
            });
            
            function setActiveTool(tool) {
                currentTool = tool;
                
                document.querySelectorAll('#annotation-toolbar button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.remove('cursor-mode');
                });
                
                if (tool === 'cursor') {
                    document.body.classList.add('cursor-mode');
                    document.getElementById('anno-cursorBtn').classList.add('cursor-mode');
                } else {
                    document.body.classList.remove('cursor-mode');
                    const activeBtn = {
                        'arrow': document.getElementById('anno-arrowBtn'),
                        'rect': document.getElementById('anno-rectBtn'),
                        'circle': document.getElementById('anno-circleBtn'),
                        'pen': document.getElementById('anno-penBtn'),
                        // 'text': document.getElementById('anno-textBtn')
                    }[tool];
                    
                    if (activeBtn) activeBtn.classList.add('active');
                }
            }
            
            // Tool buttons
            const cursorBtn = document.getElementById('anno-cursorBtn');
            const arrowBtn = document.getElementById('anno-arrowBtn');
            const rectBtn = document.getElementById('anno-rectBtn');
            const circleBtn = document.getElementById('anno-circleBtn');
            // const textBtn = document.getElementById('anno-textBtn');
            const penBtn = document.getElementById('anno-penBtn');
            const undoBtn = document.getElementById('anno-undoBtn');
            const redoBtn = document.getElementById('anno-redoBtn');
            const clearBtn = document.getElementById('anno-clearBtn');

            cursorBtn.addEventListener('click', () => setActiveTool('cursor'));
            arrowBtn.addEventListener('click', () => setActiveTool('arrow'));
            rectBtn.addEventListener('click', () => setActiveTool('rect'));
            circleBtn.addEventListener('click', () => setActiveTool('circle'));
            // textBtn.addEventListener('click', () => setActiveTool('text'));
            penBtn.addEventListener('click', () => setActiveTool('pen'));
            
            // Undo/Redo functionality
            undoBtn.addEventListener('click', () => {
                if (drawings.length > 0) {
                    undoneDrawings.push(drawings.pop());
                    redrawAll();
                }
            });
            
            redoBtn.addEventListener('click', () => {
                if (undoneDrawings.length > 0) {
                    drawings.push(undoneDrawings.pop());
                    redrawAll();
                }
            });
            
            document.getElementById('anno-colorSelect').addEventListener('change', () => {
                color = document.getElementById('anno-colorSelect').value;
            });
            
            document.getElementById('anno-sizeSlider').addEventListener('input', () => {
                size = parseInt(document.getElementById('anno-sizeSlider').value);
            });
            
            clearBtn.addEventListener('click', () => {
                drawings = [];
                undoneDrawings = [];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
            
            canvas.addEventListener('mousedown', (e) => {
                if (!isAnnotationActive || currentTool === 'cursor') return;
                
                document.body.classList.add('drawing-mode');
                startDrawing(e);
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isAnnotationActive || currentTool === 'cursor' || !isDrawing) return;
                draw(e);
            });
            
            canvas.addEventListener('mouseup', () => {
                document.body.classList.remove('drawing-mode');
                stopDrawing();
            });
            
            canvas.addEventListener('mouseout', () => {
                document.body.classList.remove('drawing-mode');
                stopDrawing();
            });
            
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                
                if (currentTool === 'text') {
                    showTextInput(startX, startY);
                    isDrawing = false;
                    return;
                }
                
                currentDrawing = {
                    tool: currentTool,
                    color: color,
                    size: size,
                    points: [{x: startX, y: startY}],
                    startX: startX,
                    startY: startY
                };
            }
            
            function draw(e) {
                if (!isDrawing || currentTool === 'text') return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (currentTool === 'pen') {
                    currentDrawing.points.push({x, y});
                }
                
                redrawAll();
                
                if (currentTool !== 'pen') {
                    currentDrawing.endX = x;
                    currentDrawing.endY = y;
                }
                
                drawShape(currentDrawing);
            }
            
            function stopDrawing() {
                if (!isDrawing || currentTool === 'cursor') return;
                
                if (currentDrawing && 
                    (currentTool !== 'pen') && 
                    currentDrawing.endX && currentDrawing.endY) {
                    drawings.push({...currentDrawing});
                } else if (currentDrawing && currentTool === 'pen') {
                    drawings.push({...currentDrawing});
                }
                
                isDrawing = false;
                currentDrawing = null;
            }
            
            function drawShape(drawing) {
                ctx.strokeStyle = drawing.color;
                ctx.fillStyle = drawing.color;
                ctx.lineWidth = drawing.size;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                switch (drawing.tool) {
                    case 'arrow':
                        drawArrow(ctx, drawing.startX, drawing.startY, drawing.endX, drawing.endY);
                        break;
                    case 'rect':
                        drawRect(ctx, drawing.startX, drawing.startY, drawing.endX, drawing.endY);
                        break;
                    case 'circle':
                        drawCircle(ctx, drawing.startX, drawing.startY, drawing.endX, drawing.endY);
                        break;
                    case 'pen':
                        drawFreehand(ctx, drawing.points);
                        break;
                    case 'text':
                        drawText(ctx, drawing.text, drawing.x, drawing.y);
                        break;
                }
            }
            
            function drawArrow(ctx, fromX, fromY, toX, toY) {
                const headLength = Math.max(10, size * 3);
                const angle = Math.atan2(toY - fromY, toX - fromX);
                
                ctx.beginPath();
                ctx.moveTo(fromX, fromY);
                ctx.lineTo(toX, toY);
                ctx.stroke();
                
                // Arrow head
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(
                    toX - headLength * Math.cos(angle - Math.PI / 6),
                    toY - headLength * Math.sin(angle - Math.PI / 6)
                );
                ctx.lineTo(
                    toX - headLength * Math.cos(angle + Math.PI / 6),
                    toY - headLength * Math.sin(angle + Math.PI / 6)
                );
                ctx.closePath();
                ctx.fill();
            }
            
            function drawRect(ctx, fromX, fromY, toX, toY) {
                ctx.beginPath();
                ctx.rect(fromX, fromY, toX - fromX, toY - fromY);
                ctx.stroke();
            }
            
            function drawCircle(ctx, fromX, fromY, toX, toY) {
                const radius = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
                ctx.beginPath();
                ctx.arc(fromX, fromY, radius, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            function drawFreehand(ctx, points) {
                if (points.length < 2) return;
                
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                
                ctx.stroke();
            }
            
            function drawText(ctx, text, x, y) {
                ctx.font = `${size * 2}px Arial`;
                ctx.fillStyle = color;
                ctx.fillText(text, x, y);
            }
            
            function showTextInput(x, y) {
                const rect = container.getBoundingClientRect();
                textInput.style.display = 'block';
                textInput.style.left = `${x + rect.left}px`;
                textInput.style.top = `${y + rect.top}px`;
                textInput.style.color = color;
                textInput.style.fontSize = `${size * 2}px`;
                textInput.focus();
                textInput.innerHTML = '';
                
                const handleTextConfirm = () => {
                    const text = textInput.innerText.trim();
                    if (text !== '') {
                        drawings.push({
                            tool: 'text',
                            color: color,
                            size: size,
                            text: text,
                            x: x,
                            y: y + size * 2
                        });
                        redrawAll();
                    }
                    textInput.style.display = 'none';
                    textInput.removeEventListener('keydown', handleKeyDown);
                    textInput.removeEventListener('blur', handleTextConfirm);
                };
                
                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleTextConfirm();
                    }
                };
                
                textInput.addEventListener('keydown', handleKeyDown);
                textInput.addEventListener('blur', handleTextConfirm);
            }
            
            // Initialize settings
            setActiveTool('arrow');
        }
    </script>

</body>
</html>
